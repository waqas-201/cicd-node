  name: CI workflow

  on:
    push:
      branches:
        - main
    

  jobs:
    build:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout code
          uses: actions/checkout@v4  

        - name: Setup Node.js from .nvmrc
          uses: actions/setup-node@v4
          with:
            node-version-file: '.nvmrc'

        - name: Install dependencies
          run: npm install

        - name: Check linting
          run: npm run lint

        - name: Build the project
          run: npm run build

    deploy:
      needs: build  # ‚¨ÖÔ∏è Wait for CI job to pass
      runs-on: ubuntu-latest

      steps:
        - name: üöÄ Deploy to EC2
          uses: appleboy/ssh-action@v0.1.10
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ubuntu
            key: ${{ secrets.EC2_SSH_KEY }}
            script: |
              export NVM_DIR="$HOME/.nvm"
              source "$NVM_DIR/nvm.sh"
              cd ~/cicd-node
              git pull origin main
              npm install
               # Restart if already running, else start it
                if pm2 list | grep -q 'app'; then
               pm2 restart app.js
              else
              pm2 start app.js 
              fi